steps:
- checkout: self
  submodules: true

- task: CMake@1
  inputs:
    cmakeArgs: $(Build.SourcesDirectory) -GNinja -DENABLE_EMBREE=$(enable_embree) -DENABLE_OPTIX=$(enable_optix) -GNinja
    workingDirectory: $(Build.BinariesDirectory)

- script: nice -n 19 ninja -j 4
  displayName: Compile
  workingDirectory: $(Build.BinariesDirectory)

- script: python3 -m pytest -v --durations=0
  displayName: Unit test
  workingDirectory: $(Build.BinariesDirectory)

- script: for i in *.py; do python3 $i; done
  displayName: Render gallery images
  condition: eq(variables.test_gallery_images, true)
  workingDirectory: doc/gallery
  env:
    PYTHONPATH: $(Build.BinariesDirectory)

